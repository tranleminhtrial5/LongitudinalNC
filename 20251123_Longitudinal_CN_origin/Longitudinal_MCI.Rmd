---
title: "Longitudinal trajectories of segmental bioimpedance and cognitive conversion in older adults"
output: html_notebook
---

Longitudinal trajectories of segmental bioimpedance and cognitive conversion in older adults

------------------------------------------------------------------------

```{r}
# Data manipulation
library(dplyr)
library(tidyr)
library(tibble)
library(lubridate)
library(stringr)

# Visualization
library(ggplot2)
library(cowplot)
library(ggpubr)
library(patchwork)
library(sjPlot)

# Statistical analysis
library(lme4)
library(rstatix)
library(effectsize)
library(emmeans)
library(broom)
library(broom.mixed)

# Reporting
library(gtsummary)
library(flextable)
library(summarytools)
library(tableone)
library(effsize) 

```

Required Libraries

```{r}
df <- read.csv("Chosun5yBIApreprocess.csv", stringsAsFactors = FALSE)

remove_list <- c("a_458", "a_525", "F_278", "a_031", "C_124", "F_043")
df <- df %>% filter(!(k_no %in% remove_list))

df <- df %>%
  mutate(datetest = as.Date(datetest, format = "%m/%d/%Y"))

df2 <- df %>%
  group_by(USUBJID) %>%
  filter(n() >= 2) %>%
  ungroup()

df2 <- df2 %>%
  arrange(USUBJID, datetest)

df3 <- df2 %>%
  group_by(USUBJID) %>%
  mutate(
    Initial_Status = first(diagnosis),
    Final_Status = last(diagnosis),
    Transition     = paste(Initial_Status, "-", Final_Status),
    Change_Type    = case_when(
      Initial_Status == "CN"  & Final_Status == "CN"  ~ "StableCN",
      Initial_Status == "CN"  & Final_Status == "MCI" ~ "CNtransitMCI",
      Initial_Status == "MCI" & Final_Status == "CN"  ~ "MCItransitCN",
      Initial_Status == "MCI" & Final_Status == "MCI" ~ "StableMCI",
      Initial_Status == "MCI" & Final_Status == "AD"  ~ "MCItransitAD",
      Initial_Status == "CN"  & Final_Status == "AD"  ~ "CNtransitAD",
      Initial_Status == "AD"  & Final_Status == "MCI" ~ "ADtransitMCI",
      Initial_Status == "AD"  & Final_Status == "CN"  ~ "ADtransitCN",
      Initial_Status == "AD"  & Final_Status == "AD"  ~ "StableAD",
      TRUE ~ NA_character_
    ),
    visit_count = n(),
    baseline_date = first(datetest),
    elapsed_years = as.numeric(difftime(datetest, baseline_date, units = "days")) / 365.25,
    elapsed_years_First_to_Last = as.numeric(difftime(last(datetest), first(datetest), units = "days")) / 365.25
  ) %>%
  ungroup()

df4 <- df3 %>%
  filter(elapsed_years_First_to_Last >= 0.916666666)

#write.csv(df4, "df4.csv",row.names = FALSE)
```

```{r}
group_counts <- df4 %>%
  group_by(Transition, Change_Type) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)

print(head(df4))
print(group_counts)

# Unique participant-level summary for each Transition and Change_Type group
participant_group_summary <- df4 %>%
  group_by(USUBJID) %>%
  summarise(
    Transition = first(Transition),
    Change_Type = first(Change_Type)
  ) %>%
  group_by(Transition, Change_Type) %>%
  summarise(
    n_participants = n(),
    participants = paste(USUBJID, collapse = ", ")
  ) %>%
  ungroup()

print(participant_group_summary)

```

```{r}
df_baseline <- df4 %>%
  filter(Change_Type %in% c("StableMCI", "MCItransitCN"))

df_baseline <- df_baseline %>%
  group_by(USUBJID) %>%
  filter(datetest == min(datetest)) %>%
  ungroup()

#write.csv(df_baseline, "df_baseline.csv",row.names = FALSE)
```

```{r}
library(tableone)
library(effsize)

df_baseline$SEX <- as.factor(df_baseline$SEX)
df_baseline$Change_Type <- as.factor(df_baseline$Change_Type)

vars_table1 <- c('SEX','AGE','EDUYR','gds','kdsq','visitcount','MMSE',
                 'SNSB_attention','SNSB_language','SNSB_visuospatial','SNSB_memory','SNSB_frontal')
vars_table2 <- c('height','weight','Waistcir','Hipcir','sysbp','diabp','bmi','ac','whr',
                 'pbcm','pbf','bmr','tbw_ffm','ecw_tcw','PA50_total')
vars_table3 <- c('ECW_ICW_upper','ECW_ICW_lower','Water_Lean_upper','Water_Lean_lower',
                 'R_upper','R_lower','Xc_upper','Xc_lower','PA_upper','PA_lower',
                 'R_H_upper','R_H_lower','Xc_H_upper','Xc_H_lower')
group_var <- "Change_Type"
covars <- c("AGE", "SEX", "EDUYR")

tab1 <- CreateTableOne(vars=vars_table1, strata=group_var, data=df_baseline)
print(tab1, showAllLevels=TRUE, quote=TRUE, noSpaces=TRUE)

get_pvals_es <- function(varlist, groupvar, df){
  res <- lapply(varlist, function(v){
    vals <- df[[v]]; g <- df[[groupvar]]
    non_missing <- !(is.na(vals) | is.na(g))
    vals_nm <- vals[non_missing]
    g_nm <- g[non_missing]
    pval <- NA; effsize <- NA
    if (length(unique(g_nm)) != 2) return(list(pval=NA,effsize=NA))
    if (is.numeric(vals_nm) | is.integer(vals_nm)){
      p_norm <- tryCatch(shapiro.test(vals_nm)$p.value,error=function(e) NA)
      if (!is.na(p_norm) && p_norm > 0.05){
        ttest <- t.test(vals_nm ~ g_nm)
        pval <- ttest$p.value
        effsize <- effsize::cohen.d(vals_nm, g_nm)$estimate
      }else{
        wilcox <- wilcox.test(vals_nm ~ g_nm)
        pval <- wilcox$p.value
        effsize <- effsize::cohen.d(vals_nm, g_nm, hedges.correction=TRUE)$estimate
      }
    }else{
      tbl <- table(vals_nm, g_nm)
      pval <- if(any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      effsize <- NA
    }
    return(list(pval=pval,effsize=effsize))
  })
  names(res) <- varlist
  return(res)
}
result_table1 <- get_pvals_es(vars_table1, group_var, df_baseline)
print(result_table1)

get_group_coef <- function(res, group_var, df) {
  levs <- levels(df[[group_var]])
  target_lev <- levs[2]
  target_name <- grep(target_lev, rownames(coef(res)), value=TRUE)
  if(length(target_name) == 1) {
    pval <- coef(res)[target_name, "Pr(>|t|)"]
    est <- coef(res)[target_name, "Estimate"]
  } else {
    pval <- NA
    est <- NA
  }
  return(list(pval=pval, estimate=est))
}

ancova_tab2 <- lapply(vars_table2, function(v){
  formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR"))
  model <- lm(formula, data=df_baseline, na.action=na.exclude)
  res <- summary(model)
  grp <- get_group_coef(res, group_var, df_baseline)
  return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab2) <- vars_table2

ancova_tab3 <- lapply(vars_table3, function(v){
  formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR"))
  model <- lm(formula, data=df_baseline, na.action=na.exclude)
  res <- summary(model)
  grp <- get_group_coef(res, group_var, df_baseline)
  return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab3) <- vars_table3

print_ancova <- function(res_list, units = NULL) {
  for (v in names(res_list)) {
    est <- res_list[[v]]$estimate
    pval <- res_list[[v]]$pval
    u <- if(!is.null(units) && !is.na(units[v])) units[v] else ""
    cat(sprintf("%-25s Estimate: %8.3f %-5s | p-value: %.4f\n", v, est, u, pval))
  }
}

units_table2 <- c(height = "cm", weight = "kg", BMI = "", whr = "", pbcm = "%", pbf = "%", bmr = "kcal", ecw_tcw = "%", tbw_ffm = "%", PA50_total = "degree")
units_table3 <- c(
  ECW_ICW_upper = "%", ECW_ICW_lower = "%", Water_Lean_upper = "%", Water_Lean_lower = "%",
  R_upper = "Ω", R_lower = "Ω", Xc_upper = "Ω", Xc_lower = "Ω", PA_upper = "degree", PA_lower = "degree",
  R_H_upper = "Ω", R_H_lower = "Ω", Xc_H_upper = "Ω", Xc_H_lower = "Ω"
)

cat("\n===== Table 2: ANCOVA Results =====\n")
print_ancova(ancova_tab2, units_table2)

cat("\n===== Table 3: ANCOVA Results =====\n")
print_ancova(ancova_tab3, units_table3)

ggplot(df_baseline, aes(x=Change_Type, y=R_lower, fill=Change_Type)) +
  geom_violin(trim=FALSE) +
  geom_boxplot(width=0.1, fill="white") +
  labs(title="R_lower by Group", y="R_lower") +
  theme_minimal()

#write.csv(print(tab1, quote = TRUE, noSpaces = TRUE), "table1_baseline.csv")
tbl2_results <- sapply(names(ancova_tab2), function(var) c(Estimate = ancova_tab2[[var]]$estimate, Pvalue = ancova_tab2[[var]]$pval))
#write.csv(tbl2_results, "table2_ancova.csv")
tbl3_results <- sapply(names(ancova_tab3), function(var) c(Estimate = ancova_tab3[[var]]$estimate, Pvalue = ancova_tab3[[var]]$pval))
#write.csv(tbl3_results, "table3_ancova.csv")

```

```{r}
library(tidyverse)
library(ggplot2)
library(cowplot)

bia_vars <- c("MMSE","SNSB_attention","SNSB_language", "SNSB_visuospatial", "SNSB_memory", "SNSB_frontal","bmi","whr","pbcm","pbf","bmr","ecw_tcw","tbw_ffm","PA50_total",
              "ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
              "R_upper","R_lower","Xc_upper","Xc_lower",
              "PA_upper","PA_lower","R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower")

df_long.analysis <- df4 %>%
  filter(Change_Type %in% c("StableMCI", "MCItransitCN"))

spaghetti_plots <- lapply(bia_vars, function(var) {
  ggplot(df_long.analysis, aes(x = elapsed_years, y = .data[[var]], group = USUBJID, color = Change_Type)) +
    geom_line(alpha = 0.35) +
    geom_smooth(aes(group = Change_Type, color = Change_Type), method = "loess", se = FALSE, linewidth = 1.5) +
    labs(title = paste("Spaghetti Plot:", var), y = var, x = "Years") +
    theme_minimal()
})

do.call(cowplot::plot_grid, c(spaghetti_plots[1:6], ncol = 2))

do.call(cowplot::plot_grid, c(spaghetti_plots[1:9], ncol = 3))

print(spaghetti_plots[[1]])   # Sửa chỉ số để xem plot bất kỳ

for(i in seq_along(bia_vars)) {
  ggsave(filename = paste0("spaghetti_", bia_vars[i], ".png"),
         plot = spaghetti_plots[[i]], width = 6, height = 4)
}
```

```{r}
library(lmerTest)  # load this instead of lme4 for fitted model

plot_lmer_predictions_with_stats <- function(data, response = "whr", 
                                            xvar = "elapsed_years", groupvar = "Change_Type",
                                            covariates = c("AGE", "SEX", "EDUYR"),
                                            n_points = 100) {
  formula_str <- paste0(response, " ~ ", xvar, "*", groupvar, " + ",
                        paste(covariates, collapse = " + "), " + (1 + ", xvar, " | USUBJID)")
  mod <- lmer(as.formula(formula_str), data = data)
  
  # Create prediction data
  newdata <- expand.grid(
    elapsed_years = seq(min(data[[xvar]], na.rm = TRUE), max(data[[xvar]], na.rm = TRUE), length.out = n_points),
    Group = unique(data[[groupvar]])
  )
  for (cov in covariates) {
    if (is.numeric(data[[cov]])) {
      newdata[[cov]] <- median(data[[cov]], na.rm = TRUE)
    } else if (is.factor(data[[cov]])) {
      newdata[[cov]] <- levels(data[[cov]])[1]
    }
  }
  
  # Predict fixed effects
  newdata$predicted <- predict(mod, newdata = newdata, re.form = NA)
  
  # Extract coefficients with p-values
  fixef_summary <- summary(mod)$coefficients
  fixef_df <- as.data.frame(fixef_summary)
  fixef_df$Term <- rownames(fixef_df)
  
  sig_stars <- function(p) {
    if (p < 0.001) "***" else if (p < 0.01) "**" else if (p < 0.05) "*" else ""
  }
  fixef_df$stars <- sapply(fixef_df$`Pr(>|t|)`, sig_stars)
  fixef_df$label <- paste0(fixef_df$Term, ": ", round(fixef_df$Estimate, 3), " ", fixef_df$stars)
  print(fixef_df)
  y_top <- max(newdata$predicted, na.rm = TRUE)
  y_spacing <- (y_top - min(newdata$predicted, na.rm = TRUE)) * 0.05
  y_positions <- seq(y_top, y_top - y_spacing * (nrow(fixef_df) - 1), length.out = nrow(fixef_df))
  annot_df <- data.frame(
    x = rep(min(newdata[[xvar]]), nrow(fixef_df)),
    y = y_positions,
    label = fixef_df$label
  )
  
  p <- ggplot(newdata, aes_string(x = xvar, y = "predicted", color = groupvar)) +
    geom_line(size = 1.2) +
    geom_text(data = annot_df, aes(x = x, y = y, label = label), hjust = 0, size = 3, inherit.aes = FALSE) +
    labs(title = paste("Predicted", response, "Trajectories by", groupvar),
         x = xvar,
         y = paste("Predicted", response)) +
    theme_minimal()
  
  print(summary(mod))
  
  return(p)
}

```

```{r}
library(lmerTest)
# Fit random intercept and slope LME model
mod <- lmer(bmi ~ elapsed_years*Change_Type  + AGE + SEX + EDUYR  + (1 + elapsed_years| USUBJID), data = df_long.analysis, REML = TRUE)
summary(mod)
```

```{r}
library(emmeans)
library(broom.mixed)

analyze_longitudinal_trends <- function(data, 
                                        response = "whr",
                                        xvar = "elapsed_years", 
                                        groupvar = "Change_Type",
                                        covariates = c("AGE", "SEX", "EDUYR"),
                                        subject_id = "USUBJID",
                                        time_points_input = c(0,1,2,3,4,5,6),
                                        reference_group = NULL,
                                        comparison_groups = NULL) {
  # Ensure groupvar is factor
  if(!is.factor(data[[groupvar]])) {
    data[[groupvar]] <- as.factor(data[[groupvar]])
  }
  
  # Set reference group to first level if NULL
  group_levels <- levels(data[[groupvar]])
  if(is.null(reference_group)) reference_group <- group_levels[1]
  # Set comparison groups to all others except reference if NULL
  if(is.null(comparison_groups)) comparison_groups <- setdiff(group_levels, reference_group)
  
  # Validate that specified groups exist
  if(!(reference_group %in% group_levels)) stop("Reference group not in groupvar levels")
  if(!all(comparison_groups %in% group_levels)) stop("Some comparison groups not in groupvar levels")
  
  # Linear mixed model formula
  fixed_effects <- paste0(xvar, "*", groupvar, " + ", paste(covariates, collapse = " + "))
  random_effects <- paste0("(1 + ", xvar, " | ", subject_id, ")")
  formula_str <- paste0(response, " ~ ", fixed_effects, " + ", random_effects)
  
  # Fit model
  mod <- lmer(as.formula(formula_str), data = data)
  
  
  # Residual SD (for Cohen's d)
  sigma_resid <- sigma(mod)
  
  emt <- emtrends(mod, specs = groupvar, var = xvar)
  
  summary_emt <- summary(emt, infer = TRUE)
 
  
  trend_col <- grep("\\.trend$", colnames(summary_emt), value = TRUE)
  if(length(trend_col) != 1) stop("Unexpected number of trend columns in emtrends output")
  
  contrasts_df <- contrast(emt, method = "pairwise") %>% 
  summary(infer = TRUE, adjust = "tukey")

  
  slope_tests <- summary_emt %>%
    dplyr::rename(
      slope = !!rlang::sym(trend_col),
      group = !!rlang::sym(groupvar)
    ) %>%
    dplyr::select(group, slope, SE, df, t.ratio, p.value, lower.CL, upper.CL)
  

  # Extract slopes and p-values for ref and comparisons
  extract_stats <- function(g) {
    d <- slope_tests %>% dplyr::filter(group == g)
    if(nrow(d) == 0) stop(paste("Group", g, "not found in slope tests"))
    list(slope = d$slope, p_zero = d$p.value)
  }
  
  ref_stats <- extract_stats(reference_group)
  comp_stats <- lapply(comparison_groups, extract_stats)
  names(comp_stats) <- comparison_groups
  
  # Interaction p-values
  fe <- broom.mixed::tidy(mod, effects = "fixed") %>% dplyr::select(term, p.value)
  
  interaction_pvals <- sapply(comparison_groups, function(g){
    term <- paste0(xvar, ":", groupvar, g)
    val <- fe %>% dplyr::filter(term == !!term) %>% dplyr::pull(p.value)
    if(length(val)==0) NA_real_ else val
  })
  
  # Cohen's d for each comparison slope difference
  cohens_d <- sapply(comparison_groups, function(g){
    (comp_stats[[g]]$slope - ref_stats$slope) / sigma_resid
  })
  
  # Time points in observed range
  max_elapsed <- max(data[[xvar]], na.rm = TRUE)
  time_points <- sort(time_points_input[time_points_input <= max_elapsed])
  if(length(time_points) == 0) {
    warning("No time points within observed range, using 0")
    time_points <- 0
  }
  
  # Prepare trends table with all groups
  trends <- tibble::tibble(Year = time_points) %>%
    dplyr::mutate(!!paste0(response, "_", reference_group, "_change") := ref_stats$slope * Year)
  
  for(g in comparison_groups) {
    slopes <- comp_stats[[g]]$slope
    trends <- trends %>%
      dplyr::mutate(
        !!paste0(response, "_", g, "_change") := slopes * Year,
        !!paste0("Difference_", g, "_vs_", reference_group) := (slopes - ref_stats$slope) * Year,
        !!paste0("Cohen_d_diff_", g, "_vs_", reference_group) := cohens_d[g] * Year
      )
  }
  
  trends <- trends %>% dplyr::mutate(across(-Year, ~round(., 3)))
  
  # Model summary table
  model_summary <- tibble::tibble(
    Outcome = response,
    Measure = "Annual change (linear trend)",
    !!paste0(reference_group, "_slope") := round(ref_stats$slope,4),
    !!paste0(reference_group, "_p_zero") := round(ref_stats$p_zero,4),
    Residual_SD = round(sigma_resid, 3)
  )
  
  for(g in comparison_groups) {
    model_summary[[paste0(g,"_slope")]] <- round(comp_stats[[g]]$slope,4)
    model_summary[[paste0(g,"_p_zero")]] <- round(comp_stats[[g]]$p_zero,4)
    model_summary[[paste0("p_diff_slopes_", g, "_vs_", reference_group)]] <- round(interaction_pvals[g],4)
    model_summary[[paste0("Cohen_d_diff_", g, "_vs_", reference_group)]] <- round(cohens_d[g],3)
  }
  
  list(
    trends = trends,
    model_summary = model_summary,
    model = mod,
    slope_tests = slope_tests,
    contrasts_df = contrasts_df
  )
}


#Plot the slopes
plot_slopes <- function(model_summary_list,  colors = c("StableMCI" = "#0072B2", "MCItransitCN" = "#E69F00")) {

  # Combine all model summaries
  all_summaries <- bind_rows(model_summary_list)
  
  # Identify slope and p-value columns by pattern
  slope_cols <- grep("_slope$", colnames(all_summaries), value = TRUE)
  pval_cols <- grep("_p_zero$", colnames(all_summaries), value = TRUE)
  
  # Extract outcome variable from 'Outcome' column
  outcomes <- all_summaries$Outcome
  
  # Pivot slopes longer
  slopes_long <- all_summaries %>%
    dplyr::select(Outcome, all_of(slope_cols)) %>%
    tidyr::pivot_longer(cols = -Outcome, names_to = "Group", values_to = "slope") %>%
    dplyr::mutate(Group = sub("_slope$", "", Group))
  
  # Pivot p-values longer
  pvals_long <- all_summaries %>%
    dplyr::select(Outcome, all_of(pval_cols)) %>%
    tidyr::pivot_longer(cols = -Outcome, names_to = "Group", values_to = "p_value") %>%
    dplyr::mutate(Group = sub("_p_zero$", "", Group))
  
  # Join slopes and p-values
  plot_data <- dplyr::left_join(slopes_long, pvals_long, by = c("Outcome", "Group"))
  
  # Significance labels (customize as needed)
  plot_data <- plot_data %>%
    dplyr::mutate(
      sig = case_when(
        p_value < 0.001 ~ "***",
        p_value < 0.01  ~ "**",
        p_value <= 0.05 ~ "*",
        TRUE ~ ""
      ),
      label = paste0(round(slope, 3), sig)
    )
  
  # Use default colors if not provided
  if (is.null(colors)) {
    groups <- unique(plot_data$Group)
    palette <- scales::hue_pal()(length(groups))
    colors <- setNames(palette, groups)
  }
  
  dodge_width <- 0.8
  
  ggplot(plot_data, aes(x = Outcome, y = slope, fill = Group)) +
    geom_col(position = position_dodge2(width = dodge_width), width = dodge_width, alpha = 0.8) +
    geom_text(aes(label = label), position = position_dodge2(width = dodge_width), vjust = -0.5, size = 3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
    labs(title = "Annual Change in Outcomes by Group",
         y = "Slope",
         x = "Biormarker") +
    scale_fill_manual(values = colors) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "top")
}


#Plot the p-Values of the LME
plot_pvalues <- function(model_summary_list, pvalue_pattern = "^p_diff_slopes") {
  all_summaries <- bind_rows(model_summary_list)
  
  # Find column matching the pattern for p-values
  pval_col <- grep(pvalue_pattern, colnames(all_summaries), value = TRUE)
  
  if(length(pval_col) == 0) stop("No p-value column matching pattern found")
  if(length(pval_col) > 1) {
    warning("Multiple p-value columns matched, using the first: ", pval_col[1])
    pval_col <- pval_col[1]
  }
  
  p_df <- all_summaries %>%
    dplyr::select(Outcome, !!rlang::sym(pval_col)) %>%
    dplyr::rename(p_value = !!rlang::sym(pval_col)) %>%
    dplyr::mutate(
      log10_p = -log10(pmax(p_value, 1e-10)),
      sig = dplyr::case_when(
        p_value < 0.001 ~ "***",
        p_value < 0.01  ~ "**",
        p_value <= 0.05 ~ "*",
        TRUE ~ ""
      )
    ) %>%
    dplyr::arrange(desc(log10_p))
  
  ggplot(p_df, aes(x = reorder(Outcome, log10_p), y = log10_p)) +
    geom_col(fill = "steelblue", alpha = 0.7) +
    geom_text(aes(label = paste0(round(p_value, 3), sig)), 
              hjust = -0.12, size = 3, vjust = -0.2) +
    geom_hline(yintercept = -log10(0.05), color = "red", linetype = "dashed", alpha = 0.7) +
    geom_hline(yintercept = -log10(0.01), color = "orange", linetype = "dotted", alpha = 0.5) +
    geom_hline(yintercept = -log10(0.001), color = "darkred", linetype = "dotdash", alpha = 0.5) +
    labs(title = "Significance of Group-by-Time Interaction",
         subtitle = "Dashed line: p = 0.05 | Dotted: p = 0.01 | Dash-dot: p = 0.001",
         y = expression(-log10),
         x = "Outcome") +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.margin = margin(t = 10, r = 50, b = 10, l = 10),  # Slightly more right margin
      plot.subtitle = element_text(size = 9, color = "gray50")
    ) +
    coord_cartesian(clip = "off")
}


```

```{r}

plot_lmer_interaction_with_p <- function(data, response = "TAR", 
                                        xvar = "elapsed_years", groupvar = "Change_Type",
                                        covariates = c("AGE", "SEX", "EDUYR"),
                                        colors = c("StableMCI" = "#0072B2", "MCItransitCN" = "#E69F00"), show.legend = FALSE) {
  # Build formulas
  full_formula <- paste0(response, " ~ ", xvar, "*", groupvar, " + ",
                         paste(covariates, collapse = " + "), " + (1 + ", xvar, " | USUBJID)")
  
  reduced_formula <- paste0(response, " ~ ", xvar, " + ", groupvar, " + ",
                            paste(covariates, collapse = " + "), " + (1 + ", xvar, " | USUBJID)")

  
  # Fit models with REML=FALSE for LRT
  full_mod <- lmer(as.formula(full_formula), data = data, REML = FALSE)
  reduced_mod <- lmer(as.formula(reduced_formula), data = data, REML = FALSE)

  # Likelihood ratio test for omnibus interaction
  lrt <- anova(reduced_mod, full_mod)
  chi_sq <- lrt$Chisq[2]
  df <- lrt$`Df`[2]
  p_val <- lrt$`Pr(>Chisq)`[2]
  
  # Add significance stars for omnibus p-value
  stars <- if (p_val < 0.001) "***" else if (p_val < 0.01) "**" else if (p_val < 0.05) "*" else ""
  omnibus_label <- sprintf("Interaction: Chi-sq(%d) = %.2f, p = %.4f%s", df, chi_sq, p_val, stars)

  
  # Extract individual interaction p-values from full model
  coef_sum <- summary(full_mod)$coefficients

  inter_rows <- grep(paste0(xvar, ":", groupvar), rownames(coef_sum))
  pvals <- coef_sum[inter_rows, "Pr(>|t|)"]
  names_pvals <- gsub(paste0(xvar, ":"), "", rownames(coef_sum)[inter_rows])
  names_pvals <- gsub(groupvar, "", names_pvals)
  
  pval_labels <- sapply(seq_along(pvals), function(i) {
    pval <- pvals[i]
    stars <- if (pval < 0.001) "***" else if (pval < 0.01) "**" else if (pval < 0.05) "*" else ""
    paste0("Stable X ", names_pvals[i], ": p = ", round(signif(pval, 4),4), stars)
  })
  
  annotation_text <- paste(c(pval_labels), collapse = "\n")
  
  # Build base plot
  p <- plot_model(full_mod, type = "pred", terms = c(xvar, groupvar)) +
    labs(title = "", x = xvar, y = response) +
    scale_color_manual(values = colors) +
    scale_fill_manual(values = colors) +
    theme_minimal() +
    theme(plot.margin=unit(c(0.5,0.5,2,0.5), "lines"))  # extra bottom margin
  
  if(!show.legend){
    p <- p +  theme(legend.position = "none")
  }
  
  # Add individual p-values as an annotation near top left
  x_anno <- max(data[[xvar]], na.rm = TRUE) * 0.1
  y_anno <- max(data[[response]], na.rm = TRUE) * 0.75
  p <- p + annotate("text", x = x_anno, y = y_anno, label = annotation_text, size = 3, hjust = 0, color = "black")
  
  # Add omnibus LRT Chi-square test below x-axis label with stars
  y_axis_min <- min(data[[response]], na.rm = TRUE)
  offset <- 0.1 * abs(y_axis_min)  # offset for placing below x-axis
  p + annotate("text", x = mean(range(data[[xvar]], na.rm = TRUE)), y = y_axis_min - offset,
               label = omnibus_label, size = 3, color = "black", hjust = 0.5)
  #return(p)
}

```

```{r}
(plt1 <- plot_lmer_interaction_with_p(df_long.analysis, response = "MMSE") )
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_attention"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_language") )
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_visuospatial") )
(plt5 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_memory") )
(plt6 <- plot_lmer_interaction_with_p(df_long.analysis, response = "SNSB_frontal"))

# Create first plot with legend on top and smaller text size
plt1.legend <- plot_lmer_interaction_with_p(df_long.analysis, response = "MMSE", show.legend = TRUE) +
  guides(color = guide_legend(nrow = 1)) +
  theme(legend.position = "right", text = element_text(size = 8))

# Extract legend as a separate grob
legend_b <- cowplot::get_legend(plt1.legend)

(combined_plot <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,plt6,
                             ncol = 3, label_size =10))

combined <- cowplot::plot_grid (legend_b, combined_plot,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)

#cowplot::save_plot("Longitudinal_Analysis_COGS_all.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)

```
```{r}

(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "bmi"))
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "ac"))
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "whr"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "pbcm"))
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "pbf"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "bmr"))
(plt6 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "tbw_ffm"))

(psd.tests <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,plt6,
                             ncol = 3, label_size =10))

combined <- cowplot::plot_grid (legend_b, psd.tests,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)

cowplot::save_plot("Longitudinal_Analysis_psd_OnlyMCI.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)


```

```{r}
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "ecw_tcw"))
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "PA50_total"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "ECW_ICW_upper"))
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "ECW_ICW_lower"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Water_Lean_upper"))

(psd.tests <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,
                             ncol = 3, label_size =10))

combined <- cowplot::plot_grid (legend_b, psd.tests,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)

cowplot::save_plot("Longitudinal_Analysis_psd_ratios_OnlyMCI.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)


```
```{r}
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Water_Lean_lower"))
(plt2 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "R_upper"))
(plt3 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "R_lower"))
(plt4 <- plot_lmer_interaction_with_p(df_long.analysis,  response = "Xc_upper"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "PA_upper"))
(plt6 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "PA_lower"))


(psd.flat <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,plt6,
                             ncol = 3, label_size =10))

combined <- cowplot::plot_grid (legend_b, psd.flat,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)
cowplot::save_plot("Longitudinal_Analysis_psd_flat_OnlyMCI.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)

```

```{r}
(plt1 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "R_H_upper"))
(plt2 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "R_H_lower"))
(plt3 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Xc_H_upper"))
(plt4 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "Xc_H_lower"))
(plt5 <-  plot_lmer_interaction_with_p(df_long.analysis,  response = "ac"))

(psd.flat.ratios <- cowplot::plot_grid(plt1, plt2, plt3, plt4, plt5,
                             ncol = 3, label_size =10))

combined <- cowplot::plot_grid (legend_b, psd.flat.ratios,  nrow=2, rel_heights = c(0.2/10, 9.8/10))
print(combined)

cowplot::save_plot("Longitudinal_Analysis_psd_flat_ratios.pdf", combined, ncol = 1,  base_width =13, base_height = 9.0)
```

```{r}
variables <- c("bmi", "whr", "pbcm", "pbf", "bmr", "tbw_ffm", "ecw_tcw", "PA50_total")
reference_group <- "StableCN"
comparison_groups <- c("CNtransitMCI")
colors.legend <- c("StableMCI" = "#0072B2", "MCItransitCN" = "#E69F00")

results <- lapply(variables, function(var) {
  analyze_longitudinal_trends(data = df_long.analysis, response = var, groupvar = "Change_Type", reference_group = reference_group, comparison_groups = comparison_groups)
})


# Name results
names(results) <- variables

model_summary_list <- lapply(results, function(result) {
  result$model_summary
})
# Extract all summaries into one table
all_summaries <- dplyr::bind_rows(lapply(results, function(x) x$model_summary), .id = "Variable")


plot_pvalues(model_summary_list)

(plt.slopes <- plot_slopes(model_summary_list, colors = colors.legend))
all_summaries
cowplot::save_plot("Longitudinal_Analysis_Slopes_all.pdf", plt.slopes, ncol = 1,  base_width =13, base_height = 9.0)
```

```{r}
variables <- c("ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower","R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower","R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower")

results <- lapply(variables, function(var) {
  analyze_longitudinal_trends(data = df_long.analysis, response = var, groupvar = "Change_Type", reference_group = reference_group, comparison_groups = comparison_groups)
})


# Name results
names(results) <- variables

model_summary_list <- lapply(results, function(result) {
  result$model_summary
})
# Extract all summaries into one table
all_summaries <- dplyr::bind_rows(lapply(results, function(x) x$model_summary), .id = "Variable")


plot_pvalues(model_summary_list)

(plt.slopes <- plot_slopes(model_summary_list, colors = colors.legend))
all_summaries
cowplot::save_plot("Longitudinal_Analysis_Slopes_FOOOF_.pdf", plt.slopes, ncol = 1,  base_width =13, base_height = 9.0)
```

```{r}
# Fit random intercept and slope LME model
mod <- lmer(SPR ~ elapsed_years*Change_Type  + AGE + SEX + EDUYR  + (1 + elapsed_years| USUBJID), data = df_long.analysis, REML = TRUE)
summary(mod)
```


