table2_simple <- do.call(rbind, lapply(vars_table2, function(x) make_compare_table_final(df_baseline, x, covariates)))
library(dplyr)
library(emmeans)
library(broom)
library(flextable)
library(effectsize)
# Chuẩn hóa dữ liệu - ép numeric toàn bộ
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower", "gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
make_compare_table_simpler <- function(df, var, covars, group = "Change_Type") {
if (!is.numeric(df[[var]])) return(NULL)
model <- try(lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df), silent = TRUE)
if (inherits(model, "try-error")) return(
tibble::tibble(
Variable = var,
StableCN_MeanSD = NA, ProgressiveCN_MeanSD = NA,
CI_95 = NA, p.value = NA, Hedges_g = NA
)
)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
Mean = mean(.data[[var]], na.rm = TRUE),
SD = sd(.data[[var]], na.rm = TRUE)
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
stable_mean <- ifelse(is.numeric(means$Mean[1]), round(means$Mean[1],2), NA)
stable_sd   <- ifelse(is.numeric(means$SD[1]), round(means$SD[1],2), NA)
prog_mean   <- ifelse(is.numeric(means$Mean[2]), round(means$Mean[2],2), NA)
prog_sd     <- ifelse(is.numeric(means$SD[2]), round(means$SD[2],2), NA)
ci1 <- ifelse(is.numeric(pair_df$lower.CL[1]), round(pair_df$lower.CL[1],2), NA)
ci2 <- ifelse(is.numeric(pair_df$upper.CL[1]), round(pair_df$upper.CL[1],2), NA)
pval <- ifelse(is.numeric(pair_df$p.value[1]), signif(pair_df$p.value[1],3), NA)
out <- tibble::tibble(
Variable = var,
StableCN = paste0(stable_mean, " (", stable_sd, ")"),
ProgressiveCN = paste0(prog_mean, " (", prog_sd, ")"),
CI_95 = paste0("(", ci1, ", ", ci2, ")"),
p.value = pval,
Hedges_g = round(eff,2)
)
out
}
table2_simple <- do.call(rbind, lapply(vars_table2, function(x) make_compare_table_simpler(df_baseline, x, covariates)))
table3_simple <- do.call(rbind, lapply(vars_table3, function(x) make_compare_table_simpler(df_baseline, x, covariates)))
# Làm bảng đẹp, thêm chú thích CI
table2_ft <- flextable(table2_simple) %>%
set_header_labels(StableCN = "StableCN Mean (SD)", ProgressiveCN = "ProgressiveCN Mean (SD)", CI_95 = "Mean diff (95% CI)") %>%
bold(j = "p.value", i = ~ p.value < 0.05) %>%
autofit()
table3_ft <- flextable(table3_simple) %>%
set_header_labels(StableCN = "StableCN Mean (SD)", ProgressiveCN = "ProgressiveCN Mean (SD)", CI_95 = "Mean diff (95% CI)") %>%
bold(j = "p.value", i = ~ p.value < 0.05) %>%
autofit()
table2_ft
table3_ft
library(dplyr)
library(emmeans)
library(broom)
library(flextable)
library(effectsize)
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw",,"PA50_total","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower", "gds")
library(dplyr)
library(emmeans)
library(broom)
library(flextable)
library(effectsize)
# Chuẩn hóa dữ liệu - ép numeric đầy đủ
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower", "gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
make_simple_table <- function(df, var, covars, group = "Change_Type") {
if (!is.numeric(df[[var]])) return(NULL)
model <- lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
MeanSD = paste0(round(mean(.data[[var]], na.rm = TRUE),2), " (", round(sd(.data[[var]], na.rm = TRUE),2), ")")
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
out <- tibble::tibble(
Variable = var,
`StableCN Mean (SD)` = means$MeanSD[1],
`ProgressiveCN Mean (SD)` = means$MeanSD[2],
`Mean Diff (95% CI)` = paste0(round(pair_df$estimate[1],2), " (", round(pair_df$lower.CL[1],2), ", ", round(pair_df$upper.CL[1],2), ")"),
p.value = pair_df$p.value[1],
Hedges_g = round(eff,2)
)
out
}
table2 <- do.call(rbind, lapply(vars_table2, function(x) make_simple_table(df_baseline, x, covariates)))
library(dplyr)
library(emmeans)
library(broom)
library(flextable)
library(effectsize)
# Ép numeric cho các biến cần thiết
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower","gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
make_compare_table_simple <- function(df, var, covars, group = "Change_Type") {
if (!is.numeric(df[[var]])) return(NULL)
model <- lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
# Lấy mean (SD) của từng nhóm
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
Mean = mean(.data[[var]], na.rm = TRUE),
SD = sd(.data[[var]], na.rm = TRUE)
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
out <- tibble::tibble(
Variable = var,
StableCN = sprintf("%.2f (%.2f)", means$Mean[1], means$SD[1]),
ProgressiveCN = sprintf("%.2f (%.2f)", means$Mean[2], means$SD[2]),
Mean_Diff = round(pair_df$estimate[1],2),
CI_lower = round(pair_df$lower.CL[1],2),
CI_upper = round(pair_df$upper.CL[1],2),
p.value = pair_df$p.value[1],
Hedges_g = round(eff,2)
)
out
}
table2 <- do.call(rbind, lapply(vars_table2, function(x) make_compare_table_simple(df_baseline, x, covariates)))
library(dplyr)
library(emmeans)
library(broom)
library(flextable)
library(effectsize)
# Chuẩn hóa numeric
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower","gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
numdisp <- function(x, digits=2) ifelse(is.numeric(x) & !is.na(x), round(x, digits), NA)
make_compare_table_simple <- function(df, var, covars, group = "Change_Type") {
if (!is.numeric(df[[var]])) return(NULL)
model <- lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
Mean = mean(.data[[var]], na.rm = TRUE),
SD = sd(.data[[var]], na.rm = TRUE)
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
# Bảo vệ giá trị trước khi in ra
out <- tibble::tibble(
Variable = var,
StableCN = sprintf("%.2f (%.2f)", numdisp(means$Mean[1]), numdisp(means$SD[1])),
ProgressiveCN = sprintf("%.2f (%.2f)", numdisp(means$Mean[2]), numdisp(means$SD[2])),
Mean_Diff = numdisp(pair_df$estimate[1]),
CI_lower = numdisp(pair_df$lower.CL[1]),
CI_upper = numdisp(pair_df$upper.CL[1]),
p.value = numdisp(pair_df$p.value[1], 3),
Hedges_g = numdisp(eff)
)
out
}
table2 <- do.call(rbind, lapply(vars_table2, function(x) make_compare_table_simple(df_baseline, x, covariates)))
table3 <- do.call(rbind, lapply(vars_table3, function(x) make_compare_table_simple(df_baseline, x, covariates)))
table2_ft <- flextable(table2) %>%
bold(j = "p.value", i = ~ p.value < 0.05) %>%
autofit()
table3_ft <- flextable(table3) %>%
bold(j = "p.value", i = ~ p.value < 0.05) %>%
autofit()
table2_ft
table3_ft
library(dplyr)
library(emmeans)
library(broom)
library(flextable)
library(effectsize)
# Chuẩn hóa biến numeric
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower","gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
numdisp <- function(x, digits=2) ifelse(is.numeric(x) & !is.na(x), round(x, digits), NA)
make_compare_table_simple <- function(df, var, covars, group = "Change_Type") {
# Kiểm tra biến có dữ liệu không
testdat <- df %>% select(all_of(var), all_of(group))
# Nếu < 2 nhóm hoặc thiếu toàn bộ dữ liệu numeric
if (!is.numeric(df[[var]]) || sum(!is.na(df[[var]])) < 2 ||
length(unique(df[[group]][!is.na(df[[var]])])) < 2) return(NULL)
model <- lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
Mean = mean(.data[[var]], na.rm = TRUE),
SD = sd(.data[[var]], na.rm = TRUE)
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
out <- tibble::tibble(
Variable = var,
StableCN = sprintf("%.2f (%.2f)", numdisp(means$Mean[1]), numdisp(means$SD[1])),
ProgressiveCN = sprintf("%.2f (%.2f)", numdisp(means$Mean[2]), numdisp(means$SD[2])),
Mean_Diff = numdisp(pair_df$estimate[1]),
CI_lower = numdisp(pair_df$lower.CL[1]),
CI_upper = numdisp(pair_df$upper.CL[1]),
p.value = numdisp(pair_df$p.value[1], 3),
Hedges_g = numdisp(eff)
)
out
}
table2_list <- lapply(vars_table2, function(x) make_compare_table_simple(df_baseline, x, covariates))
table3_list <- lapply(vars_table3, function(x) make_compare_table_simple(df_baseline, x, covariates))
# Chỉ giữ những biến có kết quả không NULL và không toàn NA (rowSums là NA)
table2 <- do.call(rbind, table2_list)
table2 <- table2[rowSums(is.na(table2)) < ncol(table2), ]
table3 <- do.call(rbind, table3_list)
table3 <- table3[rowSums(is.na(table3)) < ncol(table3), ]
table2_ft <- flextable(table2) %>%
bold(j = "p.value", i = ~ p.value < 0.05) %>%
autofit()
table3_ft <- flextable(table3) %>%
bold(j = "p.value", i = ~ p.value < 0.05) %>%
autofit()
# In ra bảng phân tích hoàn chỉnh
table2_ft
table3_ft
library(dplyr)
library(emmeans)
library(broom)
library(flextable)
library(effectsize)
# Ép numeric cho các biến cần thiết
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","PA50_total","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower", "gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw","PA50_total", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
make_compare_table_meanSD <- function(df, var, covars, group = "Change_Type") {
if (!is.numeric(df[[var]])) return(NULL)
model <- lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
Mean = mean(.data[[var]], na.rm = TRUE),
SD = sd(.data[[var]], na.rm = TRUE)
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
out <- tibble::tibble(
Variable = var,
StableCN = sprintf("%.2f (%.2f)", means$Mean[1], means$SD[1]),
ProgressiveCN = sprintf("%.2f (%.2f)", means$Mean[2], means$SD[2]),
Mean_Diff = round(pair_df$estimate[1],2),
CI_lower = round(pair_df$lower.CL[1],2),
CI_upper = round(pair_df$upper.CL[1],2),
p.value = pair_df$p.value[1],
Hedges_g = round(eff,2)
)
out
}
table2 <- do.call(rbind, lapply(vars_table2, function(x) make_compare_table_meanSD(df_baseline, x, covariates)))
library(dplyr)
library(emmeans)
library(effectsize)
library(flextable)
# Chuẩn hóa dữ liệu về numeric
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","PA50_total","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower", "gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw","PA50_total", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
make_compare_table_simple <- function(df, var, covars, group = "Change_Type") {
if (!is.numeric(df[[var]])) return(NULL)
model <- lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
Mean = mean(.data[[var]], na.rm = TRUE),
SD = sd(.data[[var]], na.rm = TRUE)
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
out <- tibble::tibble(
Variable = var,
StableCN = sprintf("%.2f (%.2f)", means$Mean[1], means$SD[1]),
ProgressiveCN = sprintf("%.2f (%.2f)", means$Mean[2], means$SD[2]),
Mean_Diff = round(pair_df$estimate[1],2),
CI_lower = round(pair_df$lower.CL[1],2),
CI_upper = round(pair_df$upper.CL[1],2),
p.value = pair_df$p.value[1],
Hedges_g = round(eff,2)
)
out
}
table2 <- do.call(rbind, lapply(vars_table2, function(x) make_compare_table_simple(df_baseline, x, covariates)))
library(dplyr)
library(emmeans)
library(effectsize)
library(flextable)
# Chuẩn hóa dữ liệu về numeric
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","PA50_total","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower", "gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw","PA50_total", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
safe_round <- function(x, digits=2) { if(is.numeric(x) & !is.na(x)) round(x, digits) else NA }
make_compare_table_simple <- function(df, var, covars, group = "Change_Type") {
if (!is.numeric(df[[var]])) return(NULL)
model <- lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
Mean = mean(.data[[var]], na.rm = TRUE),
SD = sd(.data[[var]], na.rm = TRUE)
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
out <- tibble::tibble(
Variable = var,
StableCN = sprintf("%.2f (%.2f)", safe_round(means$Mean[1]), safe_round(means$SD[1])),
ProgressiveCN = sprintf("%.2f (%.2f)", safe_round(means$Mean[2]), safe_round(means$SD[2])),
Mean_Diff = safe_round(pair_df$estimate[1]),
CI_lower = safe_round(pair_df$lower.CL[1]),
CI_upper = safe_round(pair_df$upper.CL[1]),
p.value = if(is.numeric(pair_df$p.value[1])) pair_df$p.value[1] else NA,
Hedges_g = safe_round(eff)
)
out
}
table2 <- do.call(rbind, lapply(vars_table2, function(x) make_compare_table_simple(df_baseline, x, covariates)))
library(dplyr)
library(emmeans)
library(effectsize)
library(flextable)
# Hàm robust cho mọi trường hợp, độ dài 0 sẽ trả NA
safe_round <- function(x, digits = 2) {
if (is.null(x) || length(x) == 0 || is.na(x)) return(NA)
if (is.numeric(x)) return(round(x, digits))
return(NA)
}
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","PA50_total","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower", "gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw","PA50_total", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
make_compare_table_simple <- function(df, var, covars, group = "Change_Type") {
if (!is.numeric(df[[var]])) return(NULL)
model <- lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
Mean = mean(.data[[var]], na.rm = TRUE),
SD = sd(.data[[var]], na.rm = TRUE)
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
out <- tibble::tibble(
Variable = var,
StableCN = sprintf("%.2f (%.2f)", safe_round(means$Mean[1]), safe_round(means$SD[1])),
ProgressiveCN = sprintf("%.2f (%.2f)", safe_round(means$Mean[2]), safe_round(means$SD[2])),
Mean_Diff = safe_round(pair_df$estimate[1]),
CI_lower = safe_round(pair_df$lower.CL[1]),
CI_upper = safe_round(pair_df$upper.CL[1]),
p.value = safe_round(pair_df$p.value[1], 4),
Hedges_g = safe_round(eff)
)
out
}
table2 <- do.call(rbind, lapply(vars_table2, function(x) make_compare_table_simple(df_baseline, x, covariates)))
table3 <- do.call(rbind, lapply(vars_table3, function(x) make_compare_table_simple(df_baseline, x, covariates))
table2_ft <- flextable(table2) %>%
library(dplyr)
library(emmeans)
library(effectsize)
library(flextable)
safe_round <- function(x, digits = 2) {
if (is.null(x) || length(x) == 0 || is.na(x)) return(NA)
if (is.numeric(x)) return(round(x, digits))
return(NA)
}
numeric_vars <- c("height","weight","bmi","whr","pbcm","pbf","bmr","ecw_tcw","PA50_total","tbw_ffm",
"ECW_ICW_upper","ECW_ICW_lower","Water_Lean_upper","Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower", "gds")
for (v in numeric_vars) if (v %in% names(df_baseline)) df_baseline[[v]] <- as.numeric(df_baseline[[v]])
vars_table2 <- intersect(c("height", "weight", "bmi", "whr", "pbcm", "pbf", "bmr", "ecw_tcw","PA50_total", "tbw_ffm"), names(df_baseline))
vars_table3 <- intersect(c("ECW_ICW_upper", "ECW_ICW_lower", "Water_Lean_upper", "Water_Lean_lower",
"R_upper","R_lower","Xc_upper","Xc_lower","PA_upper","PA_lower",
"R_H_upper","R_H_lower","Xc_H_upper","Xc_H_lower"), names(df_baseline))
covariates <- intersect(c("AGE", "SEX", "EDUYR", "gds"), names(df_baseline))
make_compare_table_simple <- function(df, var, covars, group = "Change_Type") {
if (!is.numeric(df[[var]])) return(NULL)
model <- lm(as.formula(paste(var, "~", group, "+", paste(covars, collapse = "+"))), data = df)
emm <- suppressMessages(emmeans(model, specs = group))
pair <- pairs(emm, adjust = "tukey")
pair_df <- as.data.frame(pair)
eff <- NA
try({ eff <- effectsize::hedges_g(model, var = group)[1,"Hedges_g"] }, silent = TRUE)
means <- df %>%
group_by(.data[[group]]) %>%
summarise(
Mean = mean(.data[[var]], na.rm = TRUE),
SD = sd(.data[[var]], na.rm = TRUE)
) %>%
arrange(match(.data[[group]], levels(df[[group]])))
out <- tibble::tibble(
Variable = var,
StableCN = sprintf("%.2f (%.2f)", safe_round(means$Mean[1]), safe_round(means$SD[1])),
ProgressiveCN = sprintf("%.2f (%.2f)", safe_round(means$Mean[2]), safe_round(means$SD[2])),
Mean_Diff = safe_round(pair_df$estimate[1]),
CI_lower = safe_round(pair_df$lower.CL[1]),
CI_upper = safe_round(pair_df$upper.CL[1]),
p.value = safe_round(pair_df$p.value[1], 4),
Hedges_g = safe_round(eff)
)
out
}
table2 <- do.call(rbind, lapply(vars_table2, function(x) make_compare_table_simple(df_baseline, x, covariates))
table3 <- do.call(rbind, lapply(vars_table3, function(x) make_compare_table_simple(df_baseline, x, covariates))
