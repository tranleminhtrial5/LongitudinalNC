add_count(USUBJID, name = "visit_count") %>%
mutate(datetest = mdy(datetest)) %>%
mutate(baseline_date = min(datetest, na.rm = TRUE)) %>%
mutate(elapsed_years = as.numeric(difftime(datetest, baseline_date, units = "days")) / 365.25) %>%
select(-baseline_date)
# Kiểm tra biến elapsed_years
summary(df_long.analysis$elapsed_years)
head(df_long.analysis[, c("datetest","elapsed_years")], 10)
estimate_ES <- function(data, variable, by, ...) {
# Cohen's D
d <- effsize::cohen.d(data[[variable]] ~ as.factor(data[[by]]),
conf.level=.95, pooled=TRUE, paired=FALSE,
hedges.correction=FALSE)
# Formatting statistic with CI
est <- style_sigfig((d$estimate))
ci <- style_sigfig(d$conf.int) %>% paste(collapse = ", ")
str_glue("{est} ({ci})")
}
ttest_common_variance <- function(data, variable, by, ...) {
data <- data[c(variable, by)] %>% dplyr::filter(complete.cases(.))
t.test(data[[variable]] ~ factor(data[[by]]), var.equal = TRUE, paired = FALSE) %>%
broom::tidy()
}
# Lọc dữ liệu chỉ giữ các record baseline (< 1 năm) và chỉ lấy 2 nhóm StableCN và ProgressiveCN
df_long.analysis.baseline <- df_long.analysis %>%
filter(elapsed_years < 0.9166666) %>%   # dưới 1 năm
filter(Change_Type %in% c("StableCN", "ProgressiveCN")) %>%   # chỉ lấy 2 nhóm cần so sánh
select(Change_Type, AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal)
# Tóm tắt dữ liệu theo Change_Type (thay vì Group)
tbl_summary(data= df_long.analysis.baseline,
by = Change_Type,
statistic = list(all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"),
digits = all_continuous() ~ 2,
missing_text = "(Missing)"
) %>% bold_labels() %>% add_p() %>% bold_p(0.05) %>% as_flex_table()
library(dplyr)
library(gtsummary)
library(broom)
library(effsize)
library(stringr)
library(glue)
library(magrittr) # for %>%
# Hàm tính Cohen's D kèm khoảng tin cậy
estimate_ES <- function(data, variable, by, ...) {
d <- effsize::cohen.d(data[[variable]] ~ as.factor(data[[by]]),
conf.level = 0.95, pooled = TRUE, paired = FALSE,
hedges.correction = FALSE)
est <- style_sigfig(d$estimate)
ci <- style_sigfig(d$conf.int) %>% paste(collapse = ", ")
str_glue("{est} ({ci})")
}
# Hàm t-test với giả định phương sai bằng nhau
ttest_common_variance <- function(data, variable, by, ...) {
data <- data[c(variable, by)] %>% dplyr::filter(complete.cases(.))
t.test(data[[variable]] ~ factor(data[[by]]), var.equal = TRUE, paired = FALSE) %>% broom::tidy()
}
# Lọc dữ liệu baseline dưới 1 năm, hai nhóm StableCN và ProgressiveCN
df_long.analysis.baseline <- df_long.analysis %>%
filter(elapsed_years < 0.9166666) %>%
filter(Change_Type %in% c("StableCN", "ProgressiveCN")) %>%
select(Change_Type, AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal)
# Tách riêng biến AGE để tính mean ± sd và p-value t-test
df_age <- df_long.analysis.baseline %>%
select(Change_Type, AGE) %>%
filter(!is.na(AGE))
summary_age <- df_age %>%
group_by(Change_Type) %>%
summarise(
Mean = mean(AGE, na.rm = TRUE),
SD = sd(AGE, na.rm = TRUE),
N = n()
)
library(dplyr)
library(gtsummary)
library(magrittr) # for %>%
# Chuyển các biến numeric có thể chứa số nhưng do nhập dữ liệu nhầm thành factor về numeric
df_long.analysis.baseline <- df_long.analysis %>%
filter(elapsed_years < 0.9166666) %>%
filter(Change_Type %in% c("StableCN", "ProgressiveCN")) %>%
select(Change_Type, AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal) %>%
mutate(across(where(is.factor), as.character)) %>%
mutate(across(c(AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal), as.numeric))
# Sử dụng tbl_summary bình thường cho bảng 1 với p-value
tbl_summary(
data = df_long.analysis.baseline,
by = Change_Type,
statistic = list(
all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"
),
digits = all_continuous() ~ 2,
missing_text = "(Missing)"
) %>%
bold_labels() %>%
add_p() %>%
bold_p(0.05) %>%
as_flex_table()
library(dplyr)
library(gtsummary)
library(broom)
library(magrittr) # for %>%
library(stringr)
library(glue)
# Chuẩn bị dữ liệu baseline <1 năm, nhóm StableCN, ProgressiveCN
df_long.analysis.baseline <- df_long.analysis %>%
filter(elapsed_years < 0.9166666) %>%
filter(Change_Type %in% c("StableCN", "ProgressiveCN")) %>%
select(Change_Type, AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal) %>%
mutate(across(where(is.factor), as.character)) %>%       # chuyển factor -> character
mutate(across(c(AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal), as.numeric)) # chuyển character -> numeric
# Tách MMSE ra xử lý riêng: tính mean, sd, t-test so sánh 2 nhóm
df_mmse <- df_long.analysis.baseline %>%
select(Change_Type, MMSE) %>%
filter(!is.na(MMSE))
summary_mmse <- df_mmse %>%
group_by(Change_Type) %>%
summarise(
Mean = mean(MMSE, na.rm = TRUE),
SD = sd(MMSE, na.rm = TRUE),
N = n()
)
ttest_mmse <- t.test(MMSE ~ Change_Type, data = df_mmse, var.equal = FALSE)
# Dữ liệu còn lại loại bỏ MMSE để làm tbl_summary thường
df_without_mmse <- df_long.analysis.baseline %>%
select(-MMSE)
tbl_summary_obj <- df_without_mmse %>%
tbl_summary(
by = Change_Type,
statistic = list(
all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"
),
digits = all_continuous() ~ 2,
missing_text = "(Missing)"
) %>%
bold_labels() %>%
add_p() %>%
bold_p(0.05)
# Xuất Table 1 hoàn chỉnh:
# 1) In tóm tắt MMSE riêng kèm p-value t-test
print(summary_mmse)
cat("P-value so sánh MMSE (Welch's t-test): ", signif(ttest_mmse$p.value, 3), "\n\n")
# 2) In bảng các biến còn lại
tbl_summary_obj %>% as_flex_table()
# Đọc dữ liệu gốc
library(dplyr)
library(ggplot2)
# Kiểm tra số lượng mẫu của từng nhóm
table(df_long.analysis$Change_Type)
# Kiểm tra dữ liệu của nhóm ProgressiveCN và StableCN
summary(df_long.analysis$Change_Type)
# Kiểm tra xem còn bao nhiêu mẫu sau lọc theo thời gian
df_filtered <- df_long.analysis %>%
filter(elapsed_years < 0.9166666)
table(df_filtered$Change_Type)
# Kiểm tra dữ liệu bị loại trừ
sum(is.na(df_filtered))
# Đọc dữ liệu gốc
library(dplyr)
library(ggplot2)
# Kiểm tra số lượng mẫu của từng nhóm
table(df_long.analysis$Change_Type)
# Kiểm tra dữ liệu của nhóm ProgressiveCN và StableCN
summary(df_long.analysis$Change_Type)
# Kiểm tra xem còn bao nhiêu mẫu sau lọc theo thời gian
df_filtered <- df_long.analysis %>%
filter(elapsed_years < 0.9166666)
table(df_filtered$Change_Type)
# Kiểm tra dữ liệu bị loại trừ
sum(is.na(df_filtered))
library(dplyr)
library(gtsummary)
library(broom)
library(magrittr) # for %>%
library(stringr)
library(glue)
# Lọc dữ liệu chỉ theo Change_Type, không lọc elapsed_years
df_long.analysis.baseline <- df_long.analysis %>%
filter(Change_Type %in% c("StableCN", "ProgressiveCN")) %>%
select(Change_Type, AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal) %>%
mutate(across(where(is.factor), as.character)) %>%
mutate(across(c(AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal), as.numeric))
# Tách riêng MMSE để tính mean, sd và t-test như trước
df_mmse <- df_long.analysis.baseline %>%
select(Change_Type, MMSE) %>%
filter(!is.na(MMSE))
summary_mmse <- df_mmse %>%
group_by(Change_Type) %>%
summarise(
Mean = mean(MMSE, na.rm = TRUE),
SD = sd(MMSE, na.rm = TRUE),
N = n()
)
ttest_mmse <- t.test(MMSE ~ Change_Type, data = df_mmse, var.equal = FALSE)
# Các biến còn lại ngoại trừ MMSE làm bảng summary
df_without_mmse <- df_long.analysis.baseline %>%
select(-MMSE)
tbl_summary_obj <- df_without_mmse %>%
tbl_summary(
by = Change_Type,
statistic = list(
all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"
),
digits = all_continuous() ~ 2,
missing_text = "(Missing)"
) %>%
bold_labels() %>%
add_p() %>%
bold_p(0.05)
# In kết quả
print(summary_mmse)
cat("P-value so sánh MMSE (Welch's t-test): ", signif(ttest_mmse$p.value, 3), "\n\n")
tbl_summary_obj %>% as_flex_table()
library(dplyr)
library(gtsummary)
library(broom)
library(magrittr) # for %>%
library(stringr)
library(glue)
# Lọc dữ liệu chỉ theo Change_Type, không lọc elapsed_years
df_long.analysis.baseline <- df_long.analysis %>%
filter(Change_Type %in% c("StableCN", "ProgressiveCN")) %>%
select(Change_Type, AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal) %>%
mutate(across(where(is.factor), as.character)) %>%
mutate(across(c(AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal), as.numeric))
# Tách riêng MMSE để tính mean, sd và t-test như trước
df_mmse <- df_long.analysis.baseline %>%
select(Change_Type, MMSE) %>%
filter(!is.na(MMSE))
summary_mmse <- df_mmse %>%
group_by(Change_Type) %>%
summarise(
Mean = mean(MMSE, na.rm = TRUE),
SD = sd(MMSE, na.rm = TRUE),
N = n()
)
ttest_mmse <- t.test(MMSE ~ Change_Type, data = df_mmse, var.equal = FALSE)
# Các biến còn lại ngoại trừ MMSE làm bảng summary
df_without_mmse <- df_long.analysis.baseline %>%
select(-MMSE)
tbl_summary_obj <- df_without_mmse %>%
tbl_summary(
by = Change_Type,
statistic = list(
all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"
),
digits = all_continuous() ~ 2,
missing_text = "(Missing)"
) %>%
bold_labels() %>%
add_p() %>%
bold_p(0.05)
# In kết quả
print(summary_mmse)
cat("P-value so sánh MMSE (Welch's t-test): ", signif(ttest_mmse$p.value, 3), "\n\n")
tbl_summary_obj %>% as_flex_table()
# Chuyển datetest sang dạng ngày đúng định dạng
df_long.analysis <- df_overall %>%
drop_na() %>%
mutate_if(is.character, as.factor) %>%
droplevels() %>%
add_count(USUBJID, name = "visit_count") %>%
mutate(datetest = mdy(datetest)) %>%
mutate(baseline_date = min(datetest, na.rm = TRUE)) %>%
mutate(elapsed_years = as.numeric(difftime(datetest, baseline_date, units = "days")) / 365.25) %>%
select(-baseline_date)
# Kiểm tra biến elapsed_years
summary(df_long.analysis$elapsed_years)
head(df_long.analysis[, c("datetest","elapsed_years")], 80)
library(dplyr)
library(gtsummary)
library(broom)
library(magrittr)
library(stringr)
library(glue)
# Giữ lại bản ghi baseline (lần đo đầu tiên) cho mỗi USUBJID
df_baseline <- df_long.analysis %>%
group_by(USUBJID) %>%
slice_min(order_by = datetest, with_ties = FALSE) %>%  # Lấy thời điểm đo nhỏ nhất (baseline)
ungroup()
# Lọc 2 nhóm StableCN và ProgressiveCN dựa trên biến phân loại đúng (ví dụ transitstatus hoặc Change_Type)
df_baseline_filtered <- df_baseline %>%
filter(transitstatus %in% c("Stable CN", "CN?MCI"))  # Căn cứ theo tên biến đúng trong bộ dữ liệu của bạn
# Chuẩn hóa dữ liệu các biến numeric
df_baseline_filtered <- df_baseline_filtered %>%
mutate(across(where(is.factor), as.character)) %>%
mutate(across(c(AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal), as.numeric))
# Xử lý riêng biến MMSE tách để tính mean, sd và t-test
df_mmse <- df_baseline_filtered %>%
select(transitstatus, MMSE) %>%
filter(!is.na(MMSE))
summary_mmse <- df_mmse %>%
group_by(transitstatus) %>%
summarise(
Mean = mean(MMSE, na.rm = TRUE),
SD = sd(MMSE, na.rm = TRUE),
N = n()
)
ttest_mmse <- t.test(MMSE ~ transitstatus, data = df_mmse, var.equal = FALSE)
# Tạo bảng tóm tắt các biến còn lại ngoại trừ MMSE
df_without_mmse <- df_baseline_filtered %>%
select(-MMSE)
tbl_summary_obj <- df_without_mmse %>%
tbl_summary(
by = transitstatus,
statistic = list(
all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"
),
digits = all_continuous() ~ 2,
missing_text = "(Missing)"
) %>%
bold_labels() %>%
add_p() %>%
bold_p(0.05)
library(dplyr)
library(gtsummary)
library(magrittr)
library(stringr)
library(glue)
# Lấy baseline
df_baseline <- df_long.analysis %>%
group_by(USUBJID) %>%
slice_min(order_by = datetest, with_ties = FALSE) %>%
ungroup()
# Lọc nhóm StableCN, ProgressiveCN theo biến đúng, ví dụ transitstatus
df_baseline_filtered <- df_baseline %>%
filter(transitstatus %in% c("Stable CN", "CN?MCI"))
# Chuyển các biến numeric về numeric (KHÔNG chuyển biến datetest)
numeric_vars <- c("AGE", "EDUYR", "gds", "kdsq", "sysbp", "diabp", "visit_count", "MMSE",
"SNSB_attention", "SNSB_language", "SNSB_visuospatial", "SNSB_memory", "SNSB_frontal")
df_baseline_filtered <- df_baseline_filtered %>%
mutate(across(all_of(numeric_vars), as.numeric))
# Chuyển biến ngày sang character nếu muốn hiển thị (hoặc loại bỏ biến datetest khỏi summary)
df_baseline_filtered <- df_baseline_filtered %>%
mutate(datetest_char = as.character(datetest))
# Xử lý riêng MMSE
df_mmse <- df_baseline_filtered %>%
select(transitstatus, MMSE) %>%
filter(!is.na(MMSE))
summary_mmse <- df_mmse %>%
group_by(transitstatus) %>%
summarise(
Mean = mean(MMSE, na.rm = TRUE),
SD = sd(MMSE, na.rm = TRUE),
N = n()
)
ttest_mmse <- t.test(MMSE ~ transitstatus, data = df_mmse, var.equal = FALSE)
# Bảng summary các biến khác (không có datetest)
df_summary_vars <- df_baseline_filtered %>%
select(-MMSE, -datetest)  # loại bỏ biến ngày nếu không muốn hiển thị
tbl_summary_obj <- df_summary_vars %>%
tbl_summary(
by = transitstatus,
statistic = list(
all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"
),
digits = all_continuous() ~ 2,
missing_text = "(Missing)"
) %>%
bold_labels() %>%
add_p() %>%
bold_p(0.05)
# In kết quả MMSE
print(summary_mmse)
cat("P-value so sánh MMSE (Welch's t-test): ", signif(ttest_mmse$p.value, 3), "\n\n")
# Hiển thị bảng
tbl_summary_obj %>% as_flex_table()
library(dplyr)
library(gtsummary)
library(broom)
library(magrittr) # for %>%
library(stringr)
library(glue)
# Chuẩn bị dữ liệu baseline <1 năm, nhóm StableCN, ProgressiveCN
df_long.analysis.baseline <- df_long.analysis %>%
filter(elapsed_years < 0.9166666) %>%
filter(Change_Type %in% c("StableCN", "ProgressiveCN")) %>%
select(Change_Type, AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal) %>%
mutate(across(where(is.factor), as.character)) %>%       # chuyển factor -> character
mutate(across(c(AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal), as.numeric)) # chuyển character -> numeric
# Tách MMSE ra xử lý riêng: tính mean, sd, t-test so sánh 2 nhóm
df_mmse <- df_long.analysis.baseline %>%
select(Change_Type, MMSE) %>%
filter(!is.na(MMSE))
summary_mmse <- df_mmse %>%
group_by(Change_Type) %>%
summarise(
Mean = mean(MMSE, na.rm = TRUE),
SD = sd(MMSE, na.rm = TRUE),
N = n()
)
ttest_mmse <- t.test(MMSE ~ Change_Type, data = df_mmse, var.equal = FALSE)
# Dữ liệu còn lại loại bỏ MMSE để làm tbl_summary thường
df_without_mmse <- df_long.analysis.baseline %>%
select(-MMSE)
tbl_summary_obj <- df_without_mmse %>%
tbl_summary(
by = Change_Type,
statistic = list(
all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"
),
digits = all_continuous() ~ 2,
missing_text = "(Missing)"
) %>%
bold_labels() %>%
add_p() %>%
bold_p(0.05)
# Xuất Table 1 hoàn chỉnh:
# 1) In tóm tắt MMSE riêng kèm p-value t-test
print(summary_mmse)
cat("P-value so sánh MMSE (Welch's t-test): ", signif(ttest_mmse$p.value, 3), "\n\n")
# 2) In bảng các biến còn lại
tbl_summary_obj %>% as_flex_table()
library(dplyr)
library(lubridate)
df_long.analysis <- df_overall %>%
drop_na() %>%
mutate(datetest = mdy(datetest)) %>%              # Định dạng ngày
group_by(USUBJID) %>%
arrange(datetest) %>%                             # Sắp xếp theo ngày trong từng người
mutate(
baseline_date = min(datetest, na.rm = TRUE),    # Lấy ngày đầu tiên của từng người
elapsed = as.numeric(difftime(datetest, baseline_date, units="days")) / 365.25
) %>%
select(-baseline_date) %>%
ungroup()
# Kiểm tra biến elapsed_years
summary(df_long.analysis$elapsed_years)
head(df_long.analysis[, c("datetest","elapsed_years")], 10)
library(dplyr)
library(lubridate)
df_long.analysis <- df_overall %>%
drop_na() %>%
mutate(datetest = mdy(datetest)) %>%              # Định dạng ngày
group_by(USUBJID) %>%
arrange(datetest) %>%                             # Sắp xếp theo ngày trong từng người
mutate(
baseline_date = min(datetest, na.rm = TRUE),    # Lấy ngày đầu tiên của từng người
elapsed = as.numeric(difftime(datetest, baseline_date, units="days")) / 365.25
) %>%
select(-baseline_date) %>%
ungroup()
library(dplyr)
library(lubridate)
df_long.analysis <- df_overall %>%
drop_na() %>%
mutate(datetest = mdy(datetest)) %>%              # Định dạng ngày
group_by(USUBJID) %>%
arrange(datetest) %>%                             # Sắp xếp theo ngày trong từng người
mutate(
baseline_date = min(datetest, na.rm = TRUE),    # Lấy ngày đầu tiên của từng người
elapsed_years = as.numeric(difftime(datetest, baseline_date, units="days")) / 365.25
) %>%
select(-baseline_date) %>%
ungroup()
# Kiểm tra biến elapsed_years
summary(df_long.analysis$elapsed_years)
head(df_long.analysis[, c("datetest","elapsed_years")], 10)
library(dplyr)
library(lubridate)
df_long.analysis <- df_overall %>%
drop_na() %>%
mutate(datetest = mdy(datetest)) %>%              # Định dạng ngày
group_by(USUBJID) %>%
arrange(datetest) %>%                             # Sắp xếp theo ngày trong từng người
mutate(
baseline_date = min(datetest, na.rm = TRUE),    # Lấy ngày đầu tiên của từng người
elapsed_years = as.numeric(difftime(datetest, baseline_date, units="days")) / 365.25
) %>%
select(-baseline_date) %>%
ungroup()
# Kiểm tra biến elapsed_years
summary(df_long.analysis$elapsed_years)
head(df_long.analysis[, c("datetest","elapsed_years")], 200)
library(dplyr)
library(lubridate)
df_long.analysis <- df_overall %>%
drop_na() %>%
mutate(datetest = mdy(datetest)) %>%              # Định dạng ngày
group_by(USUBJID) %>%
arrange(datetest) %>%                             # Sắp xếp theo ngày trong từng người
mutate(
baseline_date = min(datetest, na.rm = TRUE),    # Lấy ngày đầu tiên của từng người
elapsed_years = as.numeric(difftime(datetest, baseline_date, units="days")) / 365.25
) %>%
select(-baseline_date) %>%
ungroup()
# Kiểm tra biến elapsed_years
summary(df_long.analysis$elapsed_years)
head(df_long.analysis[, c("datetest","USUBJID","elapsed_years")], 50)
library(dplyr)
library(lubridate)
df_long.analysis <- df_overall %>%
drop_na() %>%
mutate(datetest = mdy(datetest)) %>%              # Định dạng ngày
group_by(USUBJID) %>%
arrange(datetest) %>%                             # Sắp xếp theo ngày trong từng người
mutate(
baseline_date = min(datetest, na.rm = TRUE),    # Lấy ngày đầu tiên của từng người
elapsed_years = as.numeric(difftime(datetest, baseline_date, units="days")) / 365.25
) %>%
select(-baseline_date) %>%
ungroup()
# Kiểm tra biến elapsed_years
summary(df_long.analysis$elapsed_years)
head(df_long.analysis[, c("datetest","USUBJID","elapsed_years")], 200)
