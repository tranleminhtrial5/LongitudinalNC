---
title: "Progressive and stable cognitive status based on bioimpedance"
output: html_notebook
---

Progressive and stable cognitive status based on bioimpedance

------------------------------------------------------------------------

```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
library(ggpubr)
library(gtsummary)
library(flextable)
library(tidyverse)
library(rstatix)
library(ggpubr)
library(summarytools)
library(cowplot)
library(patchwork)
library(lubridate)
# --- LOAD AT START OF SESSION ---
library(lmerTest)
library(broom.mixed)
library(emmeans)
library(stringr)
#library(lme4)
library(sjPlot)

```

Required Libraries

```{r}
# Read your data
setwd("C:/Users/KIOM_USER/Documents/GitHub/LongitudinalNC") 
df <- read.csv("Longitudinal_BIA_StableNCvsProgressiveNC.csv", 
               header = TRUE, stringsAsFactors = FALSE, na.strings = c("", "NA"))

df$COGNITIVESTAT <- df$COGNITIVESTAT %>%
    str_replace_all("\\.", "")   %>%      # Remove all dots
  str_trim(side = "both")       # Remove leading/trailing spaces

df <- df %>% add_count(USUBJID, name = "visit_count")

view(dfSummary(df ))

#get Empty COGNIVESTATE per year
#In the subsequent analysis
df %>%
  group_by(year) %>%
  summarise(empty_or_na_COGNIVESTATE = sum(is.na(COGNITIVESTAT) | COGNITIVESTAT == "")) %>%
  print()
```

```{r}
df.long <- df %>% 
   # filter(Group %in% c("CN", "MCI", "AD"), year %in% 2019:2024, r_squared >= 0.95) %>%
  filter(Group %in% c("CN", "MCI", "AD"), year %in% 2019:2024) %>%
  filter(!is.na(COGNITIVESTAT) & COGNITIVESTAT != "") %>% # drop NA or empty
  filter(!COGNITIVESTAT %in% c("aMCI,Dep")) %>%
  drop_na() %>% 
  add_count(USUBJID, name = "visit_count") %>%
  mutate(
    # Treat SMI as CN
    COGNITIVESTAT = ifelse(COGNITIVESTAT == "SMI", "CN", COGNITIVESTAT)
  ) 

# Keep only subjects with at least 2 valid records
df.long_multi <- df.long %>%
  group_by(USUBJID) %>%
  filter(n() >= 2) %>%
  ungroup()

(df_changes <- df.long_multi %>%
  arrange(USUBJID, year) %>%  # ensure chronological order
  group_by(USUBJID) %>%
  summarise(
    #Status_Changed = n_distinct(COGNITIVESTAT, na.rm = TRUE) > 1,
    Transitions = paste(COGNITIVESTAT, collapse = " -> ")
  ))

(df_summary <- df_changes %>%
  group_by(Transitions) %>%
  summarise(Count = n()) %>%
  mutate( Percentage = round(Count / sum(Count) * 100, 1)) %>%
  arrange(desc(Count)))

#df_demo <- df.long_multi %>% select( Group, SEX:EDUYR, MMSE,AGE) 
view(dfSummary(df.long_multi ))
```


```{r}
#ONly take note of inital and final transitions
df_overall <- df.long_multi %>%
  mutate(
    COGNITIVESTAT = case_when(
      COGNITIVESTAT %in% c("aMCI", "naMCI") ~ "MCI",
      COGNITIVESTAT == "SMI" ~ "CN",
      TRUE ~ COGNITIVESTAT
    )
  ) %>%
  arrange(USUBJID, year) %>%
  group_by(USUBJID) %>%
  mutate(
    Initial_Status = first(COGNITIVESTAT),
    Final_Status   = last(COGNITIVESTAT)
  ) %>%
  mutate(
  Transition = paste(Initial_Status, "->", Final_Status),
  Change_Type = case_when(
    Initial_Status == "CN" & Final_Status == "CN" ~ "StableCN",
    Initial_Status == "CN" & Final_Status == "MCI" ~ "ProgressiveCN",
    TRUE ~ NA_character_
  )
) %>%

  ungroup()


view(dfSummary(df_overall )) 

(df_transition_summary <- df_overall %>%
  group_by(Transition) %>%
  summarise(
    Count = n(),
    .groups = "drop"
  ) %>%
  mutate(
    Percentage = round(Count / sum(Count) * 100, 1)
  ) %>%
  arrange(desc(Count)))

#get Unique Particpants for analysis
df_unique_transitions <- df_overall %>%
  select(USUBJID, Transition, Change_Type) %>%  # keep only relevant columns
  distinct()  # keep only unique rows by ID, Transition, Change_Type

(df_summary <- df_unique_transitions %>%
  group_by(Transition, Change_Type) %>%
  summarise(
    Count = n(),
    .groups = "drop"
  ) %>%
  mutate(
    Percentage = round(Count / sum(Count) * 100, 1)
  ) %>%
  arrange(desc(Count)))


```

```{r}
df_long.analysis <- df_overall  %>%  drop_na() %>% mutate_if(is.character, as.factor) %>%   droplevels() %>%
  add_count(USUBJID, name = "visit_count") #%>% filter(Transition != "CN -> CN")

# Relevel Change_Type with "Stable" as reference
df_long.analysis$Change_Type <- relevel(factor(df_long.analysis$Change_Type), ref = "StableCN")

view(dfSummary(df_long.analysis ))


#get Unique Particpants for analysis
df_unique_transitions <- df_long.analysis %>%
  select(USUBJID, Transition, Change_Type) %>%  # keep only relevant columns
  distinct()  # keep only unique rows by ID, Transition, Change_Type

(df_summary <- df_unique_transitions %>%
  group_by(Transition, Change_Type) %>%
  summarise(
    Count = n(),
    .groups = "drop"
  ) %>%
  mutate(
    Percentage = round(Count / sum(Count) * 100, 1)
  ) %>%
  arrange(desc(Count)))


```

```{r}
# Chuyển datetest sang dạng ngày đúng định dạng
df_long.analysis <- df_long.analysis %>%
  mutate(datetest = mdy(datetest))  # Hoặc dùng ymd() tùy định dạng gốc

# Xác định ngày baseline (ngày sớm nhất trong bộ dữ liệu)
baseline_date <- min(df_long.analysis$datetest, na.rm = TRUE)

# Tạo biến elapsed_years tính khoảng cách từ baseline_date
df_long.analysis <- df_long.analysis %>%
  mutate(elapsed_years = as.numeric(difftime(datetest, baseline_date, units = "days")) / 365.25)

estimate_ES <- function(data, variable, by, ...) {
  # Cohen's D
  d <- effsize::cohen.d(data[[variable]] ~ as.factor(data[[by]]), 
                   conf.level=.95, pooled=TRUE, paired=FALSE, 
                   hedges.correction=FALSE)
  # Formatting statistic with CI
  est <- style_sigfig((d$estimate))
  ci <- style_sigfig(d$conf.int) %>% paste(collapse = ", ")
  str_glue("{est} ({ci})")
}

ttest_common_variance <- function(data, variable, by, ...) {
  data <- data[c(variable, by)] %>% dplyr::filter(complete.cases(.))
  t.test(data[[variable]] ~ factor(data[[by]]), var.equal = TRUE, paired = FALSE) %>%
  broom::tidy()
}

# Lọc dữ liệu chỉ giữ các record baseline (< 1 năm) và chỉ lấy 2 nhóm StableCN và ProgressiveCN
df_long.analysis.baseline <- df_long.analysis %>% 
  filter(elapsed_years < 0.9166666) %>%   # dưới 1 năm
  filter(Change_Type %in% c("StableCN", "ProgressiveCN")) %>%   # chỉ lấy 2 nhóm cần so sánh
  select(Change_Type, AGE:EDUYR, gds, kdsq, sysbp, diabp, visit_count, MMSE, SNSB_attention:SNSB_frontal)

# Tóm tắt dữ liệu theo Change_Type (thay vì Group)
tbl_summary(data= df_long.analysis.baseline,
   by = Change_Type,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)"),
    digits = all_continuous() ~ 2,
    missing_text = "(Missing)"
  ) %>% bold_labels() %>% add_p() %>% bold_p(0.05) %>% as_flex_table()
```

```{r}
df_long.analysis.baseline <- df_long.analysis %>% filter(elapsed_years < 0.9166666) %>% select(Group, delta:exponent)
tbl_summary(data= df_long.analysis.baseline,
   by = Group,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)"),
    digits = all_continuous() ~ 2,
    missing_text = "(Missing)"
  )%>%bold_labels()%>% add_p()%>%bold_p(0.05) %>% as_flex_table() #%>% flextable::save_as_docx(path =  "EEG_95.docx")