---
title: "Longitudinal trajectories of segmental bioimpedance and cognitive conversion in older adults"
output: html_notebook
---

Longitudinal trajectories of segmental bioimpedance and cognitive conversion in older adults

------------------------------------------------------------------------

```{r}
# Data manipulation
library(dplyr)
library(tidyr)
library(tibble)
library(lubridate)
library(stringr)

# Visualization
library(ggplot2)
library(cowplot)
library(ggpubr)
library(patchwork)
library(sjPlot)

# Statistical analysis
library(lme4)
library(lmerTest)
library(rstatix)
library(effectsize)
library(emmeans)
library(broom)
library(broom.mixed)

# Reporting
library(gtsummary)
library(flextable)
library(summarytools)
library(tableone)
library(effsize) 

```

Required Libraries

```{r}
df <- read.csv("Chosun5yBIApreprocess.csv", stringsAsFactors = FALSE)

remove_list <- c("E_237", "F_242", "a_531", "E_391", "G_31", "F_385", "a_281")
df <- df %>% filter(!(k_no %in% remove_list))

df <- df %>%
  mutate(datetest = as.Date(datetest, format = "%m/%d/%Y"))

df2 <- df %>%
  group_by(USUBJID) %>%
  filter(n() >= 2) %>%
  ungroup()

df2 <- df2 %>%
  arrange(USUBJID, datetest)

df3 <- df2 %>%
  group_by(USUBJID) %>%
  mutate(
    Initial_Status = first(diagnosis),
    Final_Status = last(diagnosis),
    Transition     = paste(Initial_Status, "-", Final_Status),
    Change_Type    = case_when(
      Initial_Status == "CN"  & Final_Status == "CN"  ~ "StableCN",
      Initial_Status == "CN"  & Final_Status == "MCI" ~ "CNtransitMCI",
      Initial_Status == "MCI" & Final_Status == "CN"  ~ "MCItransitCN",
      Initial_Status == "MCI" & Final_Status == "MCI" ~ "StableMCI",
      Initial_Status == "MCI" & Final_Status == "AD"  ~ "MCItransitAD",
      Initial_Status == "CN"  & Final_Status == "AD"  ~ "CNtransitAD",
      Initial_Status == "AD"  & Final_Status == "MCI" ~ "ADtransitMCI",
      Initial_Status == "AD"  & Final_Status == "CN"  ~ "ADtransitCN",
      Initial_Status == "AD"  & Final_Status == "AD"  ~ "StableAD",
      TRUE ~ NA_character_
    ),
    visit_count = n(),
    baseline_date = first(datetest),
    elapsed_years = as.numeric(difftime(datetest, baseline_date, units = "days")) / 365.25,
    elapsed_years_First_to_Last = as.numeric(difftime(last(datetest), first(datetest), units = "days")) / 365.25
  ) %>%
  ungroup()

df4 <- df3 %>%
  filter(elapsed_years_First_to_Last >= 0.916666666)
```

```{r}
# Step 8: Summarise transition groups
group_counts <- df4 %>%
  group_by(Transition, Change_Type) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)

print(head(df4))
print(group_counts)

# Unique participant-level summary for each Transition and Change_Type group
participant_group_summary <- df4 %>%
  group_by(USUBJID) %>%
  summarise(
    Transition = first(Transition),
    Change_Type = first(Change_Type)
  ) %>%
  group_by(Transition, Change_Type) %>%
  summarise(
    n_participants = n(),
    participants = paste(USUBJID, collapse = ", ")
  ) %>%
  ungroup()

print(participant_group_summary)

```

```{r}
df_baseline <- df4 %>%
  filter(Change_Type %in% c("StableCN", "CNtransitMCI"))

df_baseline <- df_baseline %>%
  group_by(USUBJID) %>%
  filter(datetest == min(datetest)) %>%
  ungroup()

#write.csv(df_baseline, "df_baseline.csv",row.names = FALSE)
```

```{r}
library(tableone)
library(effsize)

df_baseline$SEX <- as.factor(df_baseline$SEX)
df_baseline$Change_Type <- as.factor(df_baseline$Change_Type)

vars_table1 <- c('SEX','AGE','EDUYR','gds','kdsq','visitcount','MMSE',
                 'SNSB_attention','SNSB_language','SNSB_visuospatial','SNSB_memory','SNSB_frontal')
vars_table2 <- c('height','weight','Waistcir','Hipcir','sysbp','diabp','bmi','ac','whr',
                 'pbcm','pbf','bmr','tbw_ffm','ecw_tcw','PA50_total')
vars_table3 <- c('ECW_ICW_upper','ECW_ICW_lower','Water_Lean_upper','Water_Lean_lower',
                 'R_upper','R_lower','Xc_upper','Xc_lower','PA_upper','PA_lower',
                 'R_H_upper','R_H_lower','Xc_H_upper','Xc_H_lower')
group_var <- "Change_Type"
covars <- c("AGE", "SEX", "EDUYR")

tab1 <- CreateTableOne(vars=vars_table1, strata=group_var, data=df_baseline)
print(tab1, showAllLevels=TRUE, quote=TRUE, noSpaces=TRUE)

get_pvals_es <- function(varlist, groupvar, df){
  res <- lapply(varlist, function(v){
    vals <- df[[v]]; g <- df[[groupvar]]
    non_missing <- !(is.na(vals) | is.na(g))
    vals_nm <- vals[non_missing]
    g_nm <- g[non_missing]
    pval <- NA; effsize <- NA
    if (length(unique(g_nm)) != 2) return(list(pval=NA,effsize=NA))
    if (is.numeric(vals_nm) | is.integer(vals_nm)){
      p_norm <- tryCatch(shapiro.test(vals_nm)$p.value,error=function(e) NA)
      if (!is.na(p_norm) && p_norm > 0.05){
        ttest <- t.test(vals_nm ~ g_nm)
        pval <- ttest$p.value
        effsize <- effsize::cohen.d(vals_nm, g_nm)$estimate
      }else{
        wilcox <- wilcox.test(vals_nm ~ g_nm)
        pval <- wilcox$p.value
        effsize <- effsize::cohen.d(vals_nm, g_nm, hedges.correction=TRUE)$estimate
      }
    }else{
      tbl <- table(vals_nm, g_nm)
      pval <- if(any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      effsize <- NA
    }
    return(list(pval=pval,effsize=effsize))
  })
  names(res) <- varlist
  return(res)
}
result_table1 <- get_pvals_es(vars_table1, group_var, df_baseline)
print(result_table1)

get_group_coef <- function(res, group_var, df) {
  levs <- levels(df[[group_var]])
  target_lev <- levs[2]
  target_name <- grep(target_lev, rownames(coef(res)), value=TRUE)
  if(length(target_name) == 1) {
    pval <- coef(res)[target_name, "Pr(>|t|)"]
    est <- coef(res)[target_name, "Estimate"]
  } else {
    pval <- NA
    est <- NA
  }
  return(list(pval=pval, estimate=est))
}

ancova_tab2 <- lapply(vars_table2, function(v){
  formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR"))
  model <- lm(formula, data=df_baseline, na.action=na.exclude)
  res <- summary(model)
  grp <- get_group_coef(res, group_var, df_baseline)
  return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab2) <- vars_table2

ancova_tab3 <- lapply(vars_table3, function(v){
  formula <- as.formula(paste(v, "~", group_var, "+ AGE + SEX + EDUYR"))
  model <- lm(formula, data=df_baseline, na.action=na.exclude)
  res <- summary(model)
  grp <- get_group_coef(res, group_var, df_baseline)
  return(list(pval=grp$pval, estimate=grp$estimate, model=res))
})
names(ancova_tab3) <- vars_table3

print_ancova <- function(res_list, units = NULL) {
  for (v in names(res_list)) {
    est <- res_list[[v]]$estimate
    pval <- res_list[[v]]$pval
    u <- if(!is.null(units) && !is.na(units[v])) units[v] else ""
    cat(sprintf("%-25s Estimate: %8.3f %-5s | p-value: %.4f\n", v, est, u, pval))
  }
}

units_table2 <- c(height = "cm", weight = "kg", BMI = "", whr = "", pbcm = "%", pbf = "%", bmr = "kcal", ecw_tcw = "%", tbw_ffm = "%", PA50_total = "degree")
units_table3 <- c(
  ECW_ICW_upper = "%", ECW_ICW_lower = "%", Water_Lean_upper = "%", Water_Lean_lower = "%",
  R_upper = "Ω", R_lower = "Ω", Xc_upper = "Ω", Xc_lower = "Ω", PA_upper = "degree", PA_lower = "degree",
  R_H_upper = "Ω", R_H_lower = "Ω", Xc_H_upper = "Ω", Xc_H_lower = "Ω"
)

cat("\n===== Table 2: ANCOVA Results =====\n")
print_ancova(ancova_tab2, units_table2)

cat("\n===== Table 3: ANCOVA Results =====\n")
print_ancova(ancova_tab3, units_table3)

ggplot(df_baseline, aes(x=Change_Type, y=R_lower, fill=Change_Type)) +
  geom_violin(trim=FALSE) +
  geom_boxplot(width=0.1, fill="white") +
  labs(title="R_lower by Group", y="R_lower") +
  theme_minimal()

#write.csv(print(tab1, quote = TRUE, noSpaces = TRUE), "table1_baseline.csv")
tbl2_results <- sapply(names(ancova_tab2), function(var) c(Estimate = ancova_tab2[[var]]$estimate, Pvalue = ancova_tab2[[var]]$pval))
#write.csv(tbl2_results, "table2_ancova.csv")
tbl3_results <- sapply(names(ancova_tab3), function(var) c(Estimate = ancova_tab3[[var]]$estimate, Pvalue = ancova_tab3[[var]]$pval))
#write.csv(tbl3_results, "table3_ancova.csv")

```

```{r}


```